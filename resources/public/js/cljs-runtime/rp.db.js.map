{"version":3,"sources":["rp/db.cljs"],"mappings":";AAKA,eAAA,wCAAA,kFAAA,wEAAA,sFAAA,oFAAA,uFAAA,yEAAA,sEAAA,uEAAA,wEAAA,mEAAA,8DAAA,6DAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,mCAAA,2CAAA,2DAAA,r5CAAKA;AAeL,GAAA,QAAAC,+BAAAC,kCAAAC;AAAA;AAAA,AAAA,AAASC,aAAK,CAACC,4DAAAA,0EAAAA,hBAAcL,uDAAAA;;AAG7B,GAAA,QAAAC,+BAAAC,kCAAAI;AAAA;AAAA,AAAA,AAASC,oBAAY,gDAAA,hDAACC;;AAGtB,IAAAC,iBAAWL;IAAXM,iBAAA;IAAAC,iBACW,WAAKE;AAAL,AACE,OAACC,mDAAMP,kBAAYQ;;AAFhC,AAAA,yHAAAN,eAAAC,eAAAC,0DAAAF,eAAAC,eAAAC,9OAACC,6DAAAA,2GAAAA;AAMD;;;sBAAA,8BAAAI,pDAAMI;AAAN,AAAA,IAAAH,aAAAD;IAAAC,iBAAA,AAAAC,4BAAAD;gBAAA,AAAAE,4CAAAF,eAAA,vEAEWI;iBAFX,AAAAF,4CAAAF,eAAA,xEAEqBK;cAFrB,AAAAH,4CAAAF,eAAA,rEAEgCM;eAFhC,AAAAJ,4CAAAF,eAAA,tEAEwCO;gBAFxC,AAAAL,4CAAAF,eAAA,vEAEiDQ;aAFjD,AAAAN,4CAAAF,eAAA,pEAE2DS;WAF3D,AAAAP,4CAAAF,eAAA,lEAEkEU;AAFlE,AAGE,IAAMC,WAAS,4CAAK,AAACC;AAArB,AACE,IAAAC,WAAa1B;IAAb2B,WAAA,mFAAA,wCAAA,kFAAA,wEAAA,sFAAA,yEAAA,sEAAA,uEAAA,wEAAA,mEAAA,8DAAA,oIAAA,uEACyBH,zFAEOP,hDACCC,0DACHC,7BACCC,SACCC,3BACOC,hBACFC,uBACL,AAACM;AAVjC,AAAA,oIAAAH,SAAAC,sDAAAD,SAAAC,pMAACC,+DAAAA,kFAAAA;;AAcL;;;uBAAA,vBAAMG;AAAN,AAAA,AAAAD,gBAGG3B;;gIACI,iBAAA6B,WAAA,AAAA,5JAGA,uDAAA,hDAACG;IAHDF,WAAA,AAAAH,gBAEM9B;AAFN,AAAA,0GAAAgC,SAAAC,yCAAAD,SAAAC,7JAACC,kDAAAA,qEAAAA;;;AAKR;;;oBAAA,pBAAME,gDAEHnB,UAAUC,WAAWC,QAAQC,SAASC;AAFzC,AAAA,AAAAS,gBAGG3B;;AACD,OAACkC,gBACA,iBAAAC,WAAA,AAAA;IAAAC,WAAA,AAAAT,gBAQM9B;IARNwC,WAQWvB;IARXwB,WAQqBvB;IARrBwB,WAQgCvB;IARhCwB,WAQwCvB;IARxCwB,WAQiDvB;AARjD,AAAA,0GAAAiB,SAAAC,SAAAC,SAAAC,SAAAC,SAAAC,SAAAC,yCAAAN,SAAAC,SAAAC,SAAAC,SAAAC,SAAAC,SAAAC,vPAACV,kDAAAA,kHAAAA;;;AAYJ;;;mBAAA,nBAAMW;AAAN,AAGE,OAACC,wGAAO,iBAAAC,WAAA,AAAAjB,gBAAiB9B;AAAjB,AAAA,gIAAA+C,oDAAAA,5KAACC,6DAAAA,uEAAAA;;;AAEX;;;4BAAA,5BAAMC,gEAEHC;AAFH,AAGE,oBAAMA;AAAN,AACE,IAAMC,KAAG,iBAAAC,WAAqB,AAACG,sDAAwBL;IAA9CG,WAAuDzD;AAAvD,AAAA,0IAAAwD,SAAAC,yDAAAD,SAAAC,7MAACC,kEAAAA,qFAAAA;;AAAV,AACE,OAACE,sBAAOxD,WAAKmD;;AAFjB","names":["rp.db/schema","js/rp","js/rp.db","js/rp.db.conn","rp.db/conn","datascript.core/create-conn","js/rp.db.db-listener","rp.db/db-listener","reagent.core.atom","G__49590","G__49591","G__49592","datascript.core/listen!","_tx-report","cljs.core.swap_BANG_","cljs.core/inc","p__49594","map__49595","cljs.core/--destructure-map","cljs.core.get","rp.db/log-set!","mesocycle","microcycle","workout","exercise","set-index","weight","reps","event-id","cljs.core/random-uuid","G__49596","G__49597","datascript.core/transact!","js/Date.now","cljs.core/deref","rp.db/get-all-events","G__49598","G__49599","datascript.core/q","cljs.core.sort_by","rp.db/get-set-log","cljs.core/first","G__49604","G__49605","G__49606","G__49607","G__49608","G__49609","G__49610","rp.db/db->edn","cljs.core.pr_str","G__49637","datascript.core/serializable","rp.db/load-from-edn!","edn-str","db","G__49643","G__49644","datascript.core/from-serializable","cljs.reader.read_string","cljs.core/reset!"],"sourcesContent":["(ns rp.db\n  (:require [datascript.core :as d]\n            [reagent.core :as r]))\n\n;; DataScript schema - matches server-side event structure\n(def schema\n  {:event/id         {:db/unique :db.unique/identity}\n   :event/type       {}\n   :event/mesocycle  {}\n   :event/microcycle {}\n   :event/workout    {}\n   :event/exercise   {}\n   :event/set-index  {}\n   :event/performed-weight {}\n   :event/performed-reps   {}\n   :event/prescribed-weight {}\n   :event/prescribed-reps   {}\n   :event/timestamp  {}})\n\n;; Create the database connection\n(defonce conn (d/create-conn schema))\n\n;; Reactive atom for triggering re-renders\n(defonce db-listener (r/atom 0))\n\n;; Listen for DB changes and trigger re-renders\n(d/listen! conn :ui-listener\n           (fn [_tx-report]\n             (swap! db-listener inc)))\n\n;; ----- Transactions -----\n\n(defn log-set!\n  \"Log a completed set to the database.\"\n  [{:keys [mesocycle microcycle workout exercise set-index weight reps]}]\n  (let [event-id (str (random-uuid))]\n    (d/transact! conn\n                 [{:event/id event-id\n                   :event/type :set-completed\n                   :event/mesocycle mesocycle\n                   :event/microcycle microcycle\n                   :event/workout workout\n                   :event/exercise exercise\n                   :event/set-index set-index\n                   :event/performed-weight weight\n                   :event/performed-reps reps\n                   :event/timestamp (js/Date.now)}])))\n\n;; ----- Queries -----\n\n(defn get-all-events\n  \"Get all logged events from the database.\"\n  []\n  @db-listener  ; Subscribe to changes\n  (->> (d/q '[:find [(pull ?e [*]) ...]\n              :where [?e :event/type]]\n            @conn)\n       (sort-by :event/timestamp)))\n\n(defn get-set-log\n  \"Get the logged data for a specific set if it exists.\"\n  [mesocycle microcycle workout exercise set-index]\n  @db-listener  ; Subscribe to changes\n  (first\n   (d/q '[:find [(pull ?e [:event/performed-weight :event/performed-reps]) ...]\n          :in $ ?meso ?micro ?workout ?exercise ?idx\n          :where\n          [?e :event/mesocycle ?meso]\n          [?e :event/microcycle ?micro]\n          [?e :event/workout ?workout]\n          [?e :event/exercise ?exercise]\n          [?e :event/set-index ?idx]]\n        @conn mesocycle microcycle workout exercise set-index)))\n\n;; ----- Serialization -----\n\n(defn db->edn\n  \"Serialize the database to EDN for storage.\"\n  []\n  (pr-str (d/serializable @conn)))\n\n(defn load-from-edn!\n  \"Load database from EDN string.\"\n  [edn-str]\n  (when edn-str\n    (let [db (d/from-serializable (cljs.reader/read-string edn-str) schema)]\n      (reset! conn db))))\n"]}